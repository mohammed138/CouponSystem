@{
    ViewData["Title"] = "Coupons List";
}

<div id="couponDetailsContainer"></div>
<div id="CreateCoupon">
    <a href="javascript:void(0);" onclick="createCoupon()"> Add new Coupon</a>
</div>

<div id="couponTableContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


<script>
    $(document).ready(function () {
        function getAllCoupons(page = 1) {
            $.ajax({
                url: `/Coupons/GetAll?page=${page}`,
                type: 'GET',
                success: function (result) {
                    if (result.isSuccess && result.data) {
                        let tableContent = '';
                        result.data.$values.forEach(function (coupon) {
                            tableContent += `
                                <tr class="hover:bg-gray-50 transition duration-300" style="height:50px">
                                    <td class="border border-gray-300 px-4 py-2 text-gray-800">${coupon.name}</td>
                                    <td class="border border-gray-300 px-4 py-2 text-gray-800">${coupon.code}</td>
                                    <td class="border border-gray-300 px-4 py-2 text-gray-800">${coupon.value}</td>
                                    <td class="border border-gray-300 px-4 py-2 text-gray-800">${new Date(coupon.startDate).toLocaleDateString()}</td>
                                    <td class="border border-gray-300 px-4 py-2 text-gray-800">${new Date(coupon.endDate).toLocaleDateString()}</td>
                                    <td class="border border-gray-300 px-4 py-2 text-center">
                                        <a href="javascript:void(0);" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300" onclick="showDetails('${coupon.id}')">
                                            <i class="fas fa-eye mr-2"></i> Show Details
                                        </a>
                                        |
                                        <a href="javascript:void(0);" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300" onclick="editCoupon('${coupon.id}')">
                                            <i class="fas fa-edit mr-2"></i> Edit
                                        </a>
                                        |
                                        <a href="javascript:void(0);" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300" onclick="deleteCoupon('${coupon.id}')">
                                            <i class="fas fa-trash-alt mr-2"></i> Delete
                                        </a>
                                    </td>
                                </tr>
                            `;
                        });

                        const currentPage = result.data.meta ? result.data.meta.current_page : 1;
                        const lastPage = result.data.meta ? result.data.meta.last_page : 1;

                        $('#couponTableContainer').html(`
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="border border-gray-300 px-4 py-2 text-gray-600 font-semibold text-left">Name</th>
                                        <th class="border border-gray-300 px-4 py-2 text-gray-600 font-semibold text-left">Code</th>
                                        <th class="border border-gray-300 px-4 py-2 text-gray-600 font-semibold text-left">Value</th>
                                        <th class="border border-gray-300 px-4 py-2 text-gray-600 font-semibold text-left">Start Date</th>
                                        <th class="border border-gray-300 px-4 py-2 text-gray-600 font-semibold text-left">End Date</th>
                                        <th class="border border-gray-300 px-4 py-2 text-gray-600 font-semibold text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableContent}
                                </tbody>
                            </table>
                            <div class="mt-4 flex justify-center">
                                ${pagination(currentPage, lastPage)}
                            </div>
                        `);
                    } else {
                        alert(result.message);
                    }
                },
                error: function () {
                    alert('An error occurred while fetching coupons.');
                }
            });
        }

        function pagination(currentPage, totalPages) {
            let paginationHtml = '';
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<button class="mx-1 px-3 py-1 rounded-lg ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-gray-300'}" onclick="getAllCoupons(${i})">${i}</button>`;
            }
            return paginationHtml;
        }

        getAllCoupons();
    });


    function showDetails(id) {
        $.ajax({
            url: '/Coupons/GetDetails/' + id,
            type: 'GET',
            success: function (result) {
                let modalContent = `
                    <p>Name: ${result.data.name}</p>
                    <p>Code: ${result.data.code}</p>
                    <p>Value: ${result.data.value}</p>
                    <p>Start Date: ${new Date(result.data.startDate).toLocaleDateString()}</p>
                    <p>End Date: ${new Date(result.data.endDate).toLocaleDateString()}</p>
                    <p>Coupon Products:</p>
                    <ul>
                `;

                // Add coupon products
                result.data.couponProducts.$values.forEach(product => {
                    modalContent += `
                        <li>Product Name: ${product.product.name}</li>
                        <li>Product Price: ${product.product.price}</li>
                        <li>Product Quantity: ${product.product.quantity}</li>
                        <hr/>
                    `;
                });

                modalContent += `
                    </ul>
                    <p>Coupon Users:</p>
                    <ul>
                `;

                // Add coupon users
                result.data.couponUsers.$values.forEach(user => {
                    modalContent += `
                        <li>User ID: ${user.userId}</li>
                        <li>Usage: ${user.usage}</li>
                        <hr/>
                    `;
                });

                modalContent += `
                    </ul>
                `;

                $('#modelModal .modal-body').html(modalContent);
                $('#modelModal').removeClass('hidden');
            },
            error: function () {
                alert('An error occurred while fetching coupon details.');
            }
        });
    }
    function editCoupon(id) {
        $.ajax({
            url: '/Coupons/Edit/' + id,
            type: 'GET',
            success: function (result) {
                $('#modelModal .modal-body').html(result);
                $('#modelModal').removeClass('hidden');
            },
            error: function () {
                alert('An error occurred while fetching coupon edit form.');
            }
        });
    }

    function deleteCoupon(id) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/Coupons/Delete/' + id,
                    type: 'POST',
                    success: function () {
                        Swal.fire('Deleted!', 'Coupon has been deleted.', 'success');
                        location.reload();
                    },
                    error: function () {
                        alert('An error occurred while deleting the coupon.');
                    }
                });
            }
        });
    }

    function createCoupon() {
        $.ajax({
            url: '/Coupons/Create',
            type: 'GET',
            success: function (result) {
                $('#modelModal .modal-body').html(result);
                $('#modelModal').removeClass('hidden');
            },
            error: function () {
                alert('An error occurred while loading the create coupon form.');
            }
        });
    }
</script>
 
